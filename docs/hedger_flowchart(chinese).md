# Hedger 模块流程图

## 整体流程概览

```
┌─────────────────────────────────────────────────────────────────┐
│ 启动 Hedger 模块                                               │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 解析命令行参数                                                 │
│ - 读取配置文件路径                                             │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 加载配置文件                                                   │
│ - 解析 JSON 配置为 TokenParameter 对象                         │
│ - 创建 BiFuPrivateWSClient 实例                                │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 初始化 HedgerAgent                                             │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 1. 初始化 API 密钥和配置                                    ││
│ │ 2. 创建日志记录器                                           ││
│ │ 3. 初始化数据结构                                           ││
│ │ 4. 启动 WebSocket 客户端                                    ││
│ └─────────────────────────────────────────────────────────────┘│
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 运行主循环 (run_forever 方法)                                  │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 1. 检查配置更新                                             ││
│ │ 2. 处理风险头寸 (_handle_risk_positions 方法)               ││
│ │ 3. 检查对冲任务状态                                         ││
│ │ 4. 定期清理交易 ID                                          ││
│ └─────────────────────────────────────────────────────────────┘│
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 处理风险头寸 (_handle_risk_positions 方法)                     │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 1. 聚合风险头寸                                             ││
│ │ 2. 计算对冲数量和金额                                       ││
│ │ 3. 执行对冲操作                                             ││
│ │ 4. 更新风险头寸状态                                         ││
│ └─────────────────────────────────────────────────────────────┘│
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 处理交易事件 (handle_trade_filled 方法)                        │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 1. 去重交易 ID                                              ││
│ │ 2. 解析交易数据                                             ││
│ │ 3. 更新风险头寸                                             ││
│ │ 4. 记录交易信息                                             ││
│ └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 详细流程说明

### 1. 启动 Hedger 模块

通过命令行启动 Hedger 模块，指定配置文件路径：

```bash
# 命令行格式
python tunapy/hedger/hedger_main.py <config_file>

# 示例
python tunapy/hedger/hedger_main.py tests/test_hedger_params.json
```

### 2. 解析命令行参数

程序解析命令行参数，获取配置文件路径：

```python
if len(sys.argv) != 2:
    print("Usage: python hedger_main.py <config_file>")
    sys.exit(1)

config_file = sys.argv[1]
```

### 3. 加载配置文件

程序加载并解析 JSON 配置文件，创建 TokenParameter 和 BiFuPrivateWSClient 实例：

```python
try:
    with open(config_file, 'r') as f:
        config = json.load(f)
        param = TokenParameter(config['token_parameter'])
        # 监控bifu成交情况
        logger = create_logger(BASE_PATH, "hedger.log", 'JPM_MM')
        ws_client = BiFuPrivateWSClient(config['private_ws_client'], logger)
except Exception as e:
    print(f"Error: failed to load config file {config_file}: {e}")
    sys.exit(1)
```

### 4. 初始化 HedgerAgent

创建 HedgerAgent 实例并初始化：

1. **初始化 API 密钥和配置**：设置对冲 API 密钥、日志记录器和配置
2. **创建数据结构**：初始化风险头寸字典、线程池和任务管理
3. **初始化对冲客户端**：使用 get_private_client 创建归一化的对冲客户端
4. **启动 WebSocket 客户端**：连接到交易所的执行报告流

### 5. 运行主循环

HedgerAgent 运行主循环，处理风险头寸和对冲任务：

1. **检查配置更新**：定期检查配置是否有更新
2. **处理风险头寸**：调用 `_handle_risk_positions` 方法处理未对冲的头寸
3. **检查对冲任务状态**：调用 `wait_for_hedge_multithread` 方法检查对冲任务的执行状态
4. **定期清理交易 ID**：清理 2 小时前的交易 ID，减少内存使用

### 6. 处理风险头寸

`_handle_risk_positions` 方法处理风险头寸：

1. **聚合风险头寸**：按交易对聚合风险头寸
2. **计算对冲数量和金额**：根据风险头寸计算需要对冲的数量和金额
3. **生成客户端订单ID**：基于风险头寸的唯一标识（订单ID、交易对、方向）生成保持不变的 client_order_id
4. **执行对冲操作**：创建 NewOrder 对象并通过线程池使用 batch_make_orders 方法执行对冲
5. **更新风险头寸状态**：标记已对冲的头寸

### 7. 处理交易事件

当 WebSocket 接收到交易成交事件时，`handle_trade_filled` 方法被调用：

1. **去重交易 ID**：避免重复处理同一笔交易
2. **解析交易数据**：提取交易价格、数量、方向等信息
3. **更新风险头寸**：将交易添加到风险头寸字典
4. **记录交易信息**：记录交易详情到日志

## 数据流向

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ 交易所    │────>│ WebSocket │────>│ Hedger   │────>│ 交易所    │
│ 执行报告  │     │ 客户端    │     │ Agent    │     │ 对冲交易  │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
                                                                 │
                                                                 │
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ 日志      │<────│ Hedger   │<────│ 配置文件  │<────│ 命令行    │
│ 记录      │     │ Agent    │     │           │     │ 参数      │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
```

## 配置文件示例

```json
{
    "token_parameter" :{
        "Maker Exchange": "",
        "API KEY": "",
        "Secret": "",
        "Passphrase": "",
        "Stream URL": "",
        "Maker Symbol": "",
        "Hedge Symbol": "",
        "Hedge Exchange": "",
        "Hedger Price Decimals": "",
        "Hedger Qty Decimals": "",
        "Min Qty": "",
        "Min Amt": "",
        "Slippage": 0.01
    },
    "private_ws_client" :{
        "API KEY": "",
        "Secret": "",
        "Passphrase": "",
        "Stream URL": ""
    }
}
```

## 主要参数说明

| 参数 | 说明 | 类型 |
|------|------|------|
| Maker Exchange | 做市交易所 | 字符串 |
| API KEY | API 密钥 | 字符串 |
| Secret | API 密钥密码 | 字符串 |
| Passphrase | 密码短语（OKX 需要） | 字符串 |
| Stream URL | WebSocket 流 URL | 字符串 |
| Maker Symbol | 做市交易对 | 字符串 |
| Hedge Symbol | 对冲交易对 | 字符串 |
| Hedge Exchange | 对冲交易所 | 字符串 |
| Hedger Price Decimals | 对冲价格小数位数 | 整数 |
| Hedger Qty Decimals | 对冲数量小数位数 | 整数 |
| Min Qty | 最小订单数量 | 浮点数 |
| Min Amt | 最小订单金额 | 浮点数 |
| Slippage | 滑点设置 | 浮点数 |

## 对冲逻辑说明

### 1. 风险头寸计算

1. **单笔交易**：每笔成交的交易都会被添加到风险头寸字典
2. **头寸聚合**：按交易对聚合风险头寸，计算净头寸
3. **对冲阈值**：当风险头寸超过最小订单阈值时执行对冲

### 2. 对冲执行

1. **对冲方向**：根据风险头寸的方向确定对冲方向（多头→卖出，空头→买入）
2. **对冲价格**：根据风险头寸的平均价格确定对冲价格
3. **对冲数量**：根据风险头寸的数量确定对冲数量
4. **创建 NewOrder 对象**：构建包含所有必要字段的 NewOrder 命名元组
5. **使用 batch_make_orders**：调用归一化客户端的 batch_make_orders 方法执行对冲
6. **线程池执行**：通过线程池异步执行对冲操作
7. **处理响应**：从返回的 OrderID 对象中提取订单ID

### 3. 任务管理

1. **任务跟踪**：跟踪所有正在执行的对冲任务
2. **状态检查**：定期检查对冲任务的执行状态
3. **结果处理**：处理对冲任务的执行结果，更新日志

### 4. 归一化客户端

1. **get_private_client**：使用该函数创建归一化的对冲客户端
2. **统一接口**：所有交易所客户端都实现了 batch_make_orders 统一接口
3. **跨交易所兼容**：通过 NewOrder 命名元组和统一接口实现跨交易所对冲
4. **简化维护**：统一的接口减少了代码复杂度，便于后续维护

### 5. WebSocket 客户端

1. **UserWebsocketStreamClient**：实现了 WebSocket 连接管理和消息处理
2. **自动重连**：在连接失败时自动尝试重连
3. **异步处理**：在单独的线程中运行 WebSocket，避免阻塞主线程
4. **消息解析**：自动解析 JSON 格式的消息并传递给回调函数
5. **错误处理**：全面的异常捕获和错误日志记录

## 注意事项

1. **WebSocket 依赖**：确保 WebSocket 连接稳定，对冲模块依赖它获取成交事件
2. **API 密钥安全**：妥善保管 API 密钥，避免在配置文件中明文存储
3. **参数调优**：根据市场情况调整最小订单阈值和滑点设置
4. **风险控制**：设置合理的对冲参数，避免过度对冲
5. **网络稳定性**：确保网络连接稳定，避免因网络问题导致对冲执行异常
6. **交易所限制**：了解并遵守各交易所的 API 调用限制和规则

## 常见问题

### 1. WebSocket 连接失败
- 检查 Stream URL 是否正确
- 确认 API 密钥和签名是否正确
- 检查网络连接是否稳定

### 2. 对冲执行失败
- 检查对冲交易对是否存在
- 确认账户余额是否充足
- 验证 API 权限是否包含交易权限

### 3. 风险头寸计算错误
- 检查交易数据解析是否正确
- 确认风险头寸聚合逻辑是否正确
- 验证对冲阈值设置是否合理

### 4. 内存使用过高
- 检查交易 ID 清理逻辑是否正常工作
- 确认风险头寸字典是否正确清理已对冲的头寸
- 考虑增加清理频率

### 5. 配置更新不生效
- 检查配置更新逻辑是否正确
- 确认配置文件格式是否正确
- 验证配置版本号是否递增